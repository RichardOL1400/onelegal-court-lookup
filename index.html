<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Court Service Availability</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * { box-sizing: border-box; }
    html, body { background: transparent; margin: 0; padding: 0; }

    body {
      font-family: "IBM Plex Sans", sans-serif;
      font-size: 14px;
      line-height: 1.5;
    }

    #form-container {
      width: 100%;
      max-width: 760px;
      padding: 30px;
      background: #fff;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.06);
      box-shadow: 0 10px 25px rgba(0,0,0,0.10);
      background-clip: padding-box;
      position: relative;
      overflow: visible;
      margin: 0 auto;
    }

    /* Typography */
    h1 {
      font-size: 22px;
      font-weight: 600;
      line-height: 1.25;
      margin: 0 0 8px;
    }

    h2 {
      font-size: 18px;
      font-weight: 600;
      line-height: 1.3;
      margin: 0 0 12px;
    }

    .subhead {
      font-size: 14px;
      line-height: 1.5;
      color: #1a1a1a;
      margin: 0 0 24px;
    }

    .helper-text {
      font-size: 12px;
      line-height: 1.4;
      color: #6b6b6b;
      margin-top: 4px;
    }

    /* Grid Layout */
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 8px;
    }

    @media (max-width: 720px) {
      .grid { grid-template-columns: 1fr; }
    }

    .field {
      display: flex;
      flex-direction: column;
      position: relative;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 6px;
    }

    /* Combobox (both Court and Courthouse) */
    .combobox {
      position: relative;
      display: flex;
      align-items: center;
      height: 44px;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      background: #fff;
    }

    .combobox.disabled {
      background: #f6f6f6;
    }

    .combobox input {
      flex: 1;
      height: 100%;
      padding: 0 48px 0 14px;
      border: none;
      outline: none;
      font-family: "IBM Plex Sans", sans-serif;
      font-size: 14px;
      line-height: 1.5;
      background: transparent;
    }

    .combobox input:disabled {
      color: #9a9a9a;
      cursor: not-allowed;
    }

    .combobox:focus-within:not(.disabled) {
      border-color: #3a6edc;
      box-shadow: 0 0 0 3px rgba(58,110,220,0.15);
    }

    .combobox-chevron {
      position: absolute;
      right: 12px;
      height: 44px;
      width: 32px;
      border: none;
      background: transparent;
      pointer-events: none;
      font-size: 14px;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Listbox */
    .listbox {
      position: absolute;
      top: calc(100% + -45px);
      z-index: 10;
      width: 100%;
      max-height: 320px;
      overflow-y: auto;
      border: 1px solid #d0d0d0;
      border-radius: 6px;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
      padding: 4px 0;
      list-style: none;
      margin-left: 0;
    }

    .listbox[hidden] { display: none; }

    .listbox-group {
      padding: 12px 14px 6px;
      font-size: 12px;
      font-weight: 500;
      color: #6b6b6b;
      cursor: default;
    }

    .listbox-option {
      padding: 8px 14px;
      font-size: 14px;
      line-height: 1.4;
      cursor: pointer;
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .listbox-option:hover,
    .listbox-option[aria-selected="true"],
    .listbox-option.focused {
      background: #eef5ff;
    }

    .listbox-empty {
      padding: 10px 14px;
      font-size: 13px;
      color: #6b6b6b;
    }

    /* Reset */
    .reset-link {
      margin-top: 8px;
      background: none;
      border: none;
      color: #3a6edc;
      font-size: 13px;
      cursor: pointer;
      padding: 0;
      text-decoration: underline;
    }

    .reset-link:hover { color: #2d5ab8; }

    /* Sections and Cards */
    .section { margin-top: 24px; }

    .card {
      padding: 16px;
      border: 1px solid #d0d0d0;
      border-radius: 8px;
      background: #fff;
    }

    .card + .card { margin-top: 16px; }
    .card.hidden { display: none; }

    .card-title h2 {
      margin: 0 0 4px;
      font-size: 18px;
      font-weight: 600;
    }

    .scope {
      font-size: 12px;
      color: #6b6b6b;
      font-style: italic;
      margin-bottom: 12px;
    }

    /* Status Pills */
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid transparent;
      white-space: nowrap;
    }

    .pill .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
      opacity: 0.9;
    }

    .pill.available {
      color: #0f6b2f;
      background: #e8f6ee;
      border-color: #cdebd8;
    }

    .pill.unavailable {
      color: #9b1c1c;
      background: #fdeaea;
      border-color: #f7c8c8;
    }

    .pill.info {
      color: #0f4f6b;
      background: #eef5fb;
      border-color: #d8e5ee;
    }

    /* Rows */
    .row {
      display: flex;
      gap: 10px;
      margin: 8px 0;
      font-size: 14px;
      align-items: flex-start;
    }

    .k {
      flex: 0 0 180px;
      font-weight: 600;
      color: #444;
    }

    .v {
      flex: 1;
      color: #1a1a1a;
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    hr {
      border: 0;
      border-top: 1px solid #e6e6e6;
      margin: 14px 0;
    }

    /* Deadline Box */
    .deadline-box {
      padding: 14px 16px;
      border-radius: 8px;
      background: #eef5fb;
      border: 1px solid rgba(30,111,151,0.20);
      margin-top: 12px;
    }

    .deadline-box .label {
      font-size: 12px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .deadline-box .time {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 0.2px;
      color: #0f2f3f;
      margin-bottom: 6px;
    }

    .deadline-box .hint {
      font-size: 12px;
      color: #6b6b6b;
      line-height: 1.4;
    }

    /* Toggle */
    .toggle {
      display: inline-flex;
      align-items: center;
      border: 1px solid #d8e5ee;
      background: #f7fbfe;
      color: #0f4f6b;
      font-weight: 600;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
      margin-top: 12px;
    }

    .toggle:hover { filter: brightness(0.98); }
    .details.hidden { display: none; }

    /* Summary */
    .availability-summary {
      margin-top: 24px;
      padding: 16px;
      border-radius: 8px;
      background: #f7fbfe;
      border: 1px solid #d8e5ee;
    }

    .availability-summary.hidden { display: none; }

    .availability-summary h3 {
      margin: 0 0 12px;
      font-size: 16px;
      font-weight: 600;
    }

    .summary-grid { display: grid; gap: 12px; }

    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
    }

    .summary-label { font-weight: 600; }

    /* Prompt */
    .prompt {
      margin-top: 24px;
      padding: 12px 14px;
      border-radius: 8px;
      background: #fbfbfb;
      border: 1px dashed #d0d0d0;
      font-size: 13px;
      color: #555;
      line-height: 1.5;
    }

    .prompt.hidden { display: none; }

    /* Confirmation */
    .confirmation {
      margin-top: 16px;
      padding: 12px 14px;
      border-radius: 8px;
      background: #f0f9ff;
      border: 1px solid #c3ddf5;
      font-size: 13px;
      color: #0f4f6b;
      line-height: 1.5;
    }

    .confirmation.hidden { display: none; }

    /* Footer */
    .footer {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid #e6e6e6;
      color: #6b6b6b;
      font-size: 12px;
      line-height: 1.4;
    }

    .footer div { margin-bottom: 6px; }
  </style>
</head>

<body>
  <div id="form-container">
    <h1>Court Service Availability</h1>
    <div class="subhead">
      Select a <strong>court</strong> to see eFiling availability.<br>
      Select a <strong>specific location</strong> to see information about available physical services, such as physical filing and courtesy copy delivery.
    </div>

    <div class="grid">
      <div class="field">
        <label for="court-combobox">Court</label>

        <div class="combobox" role="combobox" aria-expanded="false" aria-haspopup="listbox">
          <input
            id="court-combobox"
            type="text"
            placeholder="Select a Court…"
            aria-autocomplete="list"
            aria-controls="court-listbox"
            aria-activedescendant=""
          />
          <button class="combobox-chevron" tabindex="-1" aria-hidden="true">▾</button>
        </div>

        <div class="helper-text">Determines eFiling availability.</div>

        <ul id="court-listbox" class="listbox" role="listbox" hidden></ul>
      </div>

      <div class="field">
        <label for="courthouse-combobox">Specific Location</label>

        <div class="combobox disabled" role="combobox" aria-expanded="false" aria-haspopup="listbox">
          <input
            id="courthouse-combobox"
            type="text"
            placeholder="Select a courthouse location…"
            aria-autocomplete="list"
            aria-controls="courthouse-listbox"
            aria-activedescendant=""
            disabled
          />
          <button class="combobox-chevron" tabindex="-1" aria-hidden="true">▾</button>
        </div>

        <div id="courthouse-helper" class="helper-text">
          Determines physical filing and courtesy copy deadlines.
        </div>

        <ul id="courthouse-listbox" class="listbox" role="listbox" hidden></ul>
      </div>
    </div>

    <button class="reset-link" id="reset-button" type="button">Reset</button>

    <!-- Availability Summary -->
    <div id="summary" class="availability-summary hidden"></div>

    <!-- eFiling (court-wide) -->
    <div id="efiling" class="card section hidden"></div>

    <!-- Instructional prompt -->
    <div id="physicalPrompt" class="prompt hidden"></div>

    <!-- Location-specific services -->
    <div id="results" class="card section hidden"></div>

    <!-- Confirmation cue -->
    <div id="confirmation" class="confirmation hidden"></div>

    <div class="footer">
      <div><strong>Data freshness:</strong> We recommend confirming time-sensitive requirements when the filing is urgent.</div>
      <div>Deadlines shown are One Legal operational cutoffs designed to help you meet court timing.</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

  <script>
  (async function () {
    const $courtInput = document.getElementById('court-combobox');
    const $courtWrapper = $courtInput.parentElement;
    const $courtListbox = document.getElementById('court-listbox');

    const $comboboxInput = document.getElementById('courthouse-combobox');
    const $comboboxWrapper = $comboboxInput.parentElement;
    const $listbox = document.getElementById('courthouse-listbox');

    const $reset = document.getElementById('reset-button');
    const $summary = document.getElementById('summary');
    const $efiling = document.getElementById('efiling');
    const $results = document.getElementById('results');
    const $physicalPrompt = document.getElementById('physicalPrompt');
    const $confirmation = document.getElementById('confirmation');

    let allCourts = [];
    let allLocations = [];
    let currentCourtName = "";
    let currentCourtInputValue = "";
    let selectedLocation = null;
    let currentLocationInputValue = "";
    let isCourtListboxOpen = false;
    let isListboxOpen = false;

    let courtFuse = null;
    let locationFuse = null;

    const esc = s => String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const isOne = v => String(v).trim() === "1";
    const uniq = arr => [...new Set(arr)].sort((a,b)=>String(a).localeCompare(String(b)));

    function hide(el){ el.classList.add('hidden'); }
    function show(el){ el.classList.remove('hidden'); }

    function formatAddress(r) {
      const a1 = (r.Address_Address1 || "").trim();
      const city = (r.Address_City || "").trim();
      const state = (r.Address_State || "").trim();
      const zip = (r.Address_PostalCode || "").trim();
      const cityStateZip = ([city, state].filter(Boolean).join(", ") + (zip ? ` ${zip}` : "")).trim();
      return [a1, cityStateZip].filter(Boolean).join(", ");
    }

    function pillHTML(isAvailable) {
      if (isAvailable === true) return `<span class="pill available">Available</span>`;
      if (isAvailable === false) return `<span class="pill unavailable">Not Available</span>`;
      return `<span class="pill info">Unknown</span>`;
    }

    function scrollToEl(el) {
      try {
        if (!el) {
          console.warn('scrollToEl called with null/undefined element');
          return;
        }
        el.scrollIntoView({ behavior: "smooth", block: "start" });
      } catch (error) {
        console.error('Error scrolling to element:', error);
      }
    }

    function wireToggles(root) {
      try {
        if (!root) {
          console.warn('wireToggles called with null/undefined root');
          return;
        }

        const toggles = root.querySelectorAll('[data-toggle]');
        toggles.forEach(btn => {
          btn.addEventListener('click', () => {
            try {
              const id = btn.getAttribute('data-toggle');
              if (!id) {
                console.warn('Toggle button missing data-toggle attribute');
                return;
              }

              const el = document.getElementById(id);
              if (!el) {
                console.warn(`Toggle target element "${id}" not found`);
                return;
              }

              const nowHidden = el.classList.toggle('hidden');
              const expanded = !nowHidden;
              btn.setAttribute('aria-expanded', String(expanded));

              // Use custom text from data attributes, or default to generic text
              const showText = btn.getAttribute('data-show-text') || "Show details";
              const hideText = btn.getAttribute('data-hide-text') || "Hide details";
              btn.textContent = expanded ? hideText : showText;

              sendHeightSoon();
            } catch (error) {
              console.error('Error in toggle click handler:', error);
            }
          });
        });
      } catch (error) {
        console.error('Error wiring toggles:', error);
      }
    }

    function renderSummary(courtWide, locationData) {
      try {
        if (!courtWide) {
          console.error('No court data provided to renderSummary');
          return;
        }

        const canEF = isOne(courtWide.CanEfiling);
        const canFile = locationData ? isOne(locationData.CanFile) : null;
        const canCC = locationData ? isOne(locationData.CanCourtesyCopy) : null;
        const canSheriff = locationData ? isOne(locationData.CanSheriff) : null;

        $summary.innerHTML = `
          <h3>Availability Summary</h3>
          <div class="summary-grid">
            <div class="summary-item">
              <span class="summary-label">eFiling</span>
              ${pillHTML(canEF)}
            </div>
            ${locationData ? `
              <div class="summary-item">
                <span class="summary-label">Physical Filing</span>
                ${pillHTML(canFile)}
              </div>
              <div class="summary-item">
                <span class="summary-label">Courtesy Copy</span>
                ${pillHTML(canCC)}
              </div>
              <div class="summary-item">
                <span class="summary-label">Sheriff Delivery</span>
                ${pillHTML(canSheriff)}
              </div>
            ` : ''}
          </div>
        `;
        show($summary);
        sendHeightSoon();
      } catch (error) {
        console.error('Error rendering summary:', error);
      }
    }

    function renderEFiling(courtWide) {
      try {
        if (!courtWide) {
          console.error('No court data provided to renderEFiling');
          return;
        }

        const canEF = isOne(courtWide.CanEfiling);
        const status = (courtWide.EFilingStatus || "").trim();
        const divisions = (courtWide.EFilingDivisions || "").trim();
        const deadline = (courtWide.EFilingDeadline || "11:59 PM").trim();
        const recBy = (courtWide.EFilingRecommendedBy || "11:45 PM").trim();
        const efm = (courtWide.EFM || "").trim();
        const maxDoc = (courtWide.MaxEfileDocSize || "").trim();
        const maxEnv = (courtWide.MaxEfileEnvSize || "").trim();
        const courtWebsite = (courtWide.CourtWebsite || "").trim();
        const efileFAQs = (courtWide.CourteFileFAQs || "").trim();
        const localRules = (courtWide.CourtLocalRulesLink || "").trim();

        const detailsId = "efiling-details";

        $efiling.innerHTML = `
          <div class="card-title">
            <h2>eFiling</h2>
            <div class="scope">Court-wide, applies to all courthouse locations</div>
          </div>

          <div class="row">
            <span class="k">Availability</span>
            <span class="v">${pillHTML(canEF)}</span>
          </div>

          ${canEF ? `
            ${divisions ? `
              <div class="row">
                <span class="k">Divisions</span>
                <span class="v">${esc(divisions)}</span>
              </div>
            ` : ""}

            <div class="deadline-box">
              <div class="label">Court Deadline</div>
              <div class="time">${esc(deadline)}</div>
              <div class="hint">Submit through One Legal by <strong>${esc(recBy)}</strong> to meet this deadline.</div>
            </div>

            <button class="toggle" type="button" data-toggle="${detailsId}" aria-expanded="false" data-show-text="eFiling details ▼" data-hide-text="eFiling details ▲">
              eFiling details ▼
            </button>

            <div id="${detailsId}" class="details hidden" style="margin-top:10px;">
              ${status ? `<div class="row"><span class="k">Status</span><span class="v">${esc(status)}</span></div>` : ""}
              ${efm ? `<div class="row"><span class="k">EFM</span><span class="v">${esc(efm)}${efm === 'FSX' ? ` <span style="font-size: 0.9em;">(Additional steps may be required to eFile in this court. <a href="https://support.onelegal.com/court-filing/connect-your-account-to-efile-in-san-francisco" target="_blank" rel="noopener noreferrer" style="color: #3a6edc; text-decoration: underline;">Learn more</a>.)</span>` : efm === 'eFileCA' ? ` <span style="font-size: 0.9em;">(Additional steps may be required to eFile in this court. <a href="https://support.onelegal.com/court-filing/how-do-i-connect-to-my-states-electronic-filing-manager-efm" target="_blank" rel="noopener noreferrer" style="color: #3a6edc; text-decoration: underline;">Learn more</a>.)</span>` : ''}</span></div>` : ""}
              ${maxDoc ? `<div class="row"><span class="k">Max Doc Size</span><span class="v">${esc(maxDoc)}</span></div>` : ""}
              ${maxEnv ? `<div class="row"><span class="k">Max Envelope Size</span><span class="v">${esc(maxEnv)}</span></div>` : ""}
              ${courtWebsite ? `<div class="row"><span class="k">Court website</span><span class="v"><a href="${esc(courtWebsite)}" target="_blank" rel="noopener noreferrer" style="color: #3a6edc; text-decoration: underline;">Website</a></span></div>` : ""}
              ${efileFAQs ? `<div class="row"><span class="k">eFiling FAQs</span><span class="v"><a href="${esc(efileFAQs)}" target="_blank" rel="noopener noreferrer" style="color: #3a6edc; text-decoration: underline;">FAQs</a></span></div>` : ""}
              ${localRules ? `<div class="row"><span class="k">Local Rules</span><span class="v"><a href="${esc(localRules)}" target="_blank" rel="noopener noreferrer" style="color: #3a6edc; text-decoration: underline;">Rules</a></span></div>` : ""}
            </div>
          ` : `
            <p style="color:#6b6b6b; font-size:13px;">This court does not currently offer eFiling through One Legal.</p>
          `}
        `;

        show($efiling);
        wireToggles($efiling);
        sendHeightSoon();
      } catch (error) {
        console.error('Error rendering eFiling section:', error);
      }
    }

    function renderPhysicalPrompt() {
      $physicalPrompt.innerHTML = `To view physical filing and courtesy copy deadlines, select a courthouse location.`;
      show($physicalPrompt);
      sendHeightSoon();
    }

    function renderLocationServices(locationData, courtWide) {
      try {
        if (!locationData) {
          console.error('No location data provided to renderLocationServices');
          return;
        }

        if (!courtWide) {
          console.error('No court data provided to renderLocationServices');
          return;
        }

        const canFile = isOne(locationData.CanFile);
        const canCC = isOne(locationData.CanCourtesyCopy);
        const canSheriff = isOne(locationData.CanSheriff);
        const addr = formatAddress(locationData);

        $results.innerHTML = `
          <div class="card-title">
            <h2>Physical Services</h2>
            <div class="scope">Courthouse-specific, varies by location</div>
          </div>

          <div class="row"><span class="k">Court</span><span class="v">${esc(locationData.DisplayName || 'N/A')}</span></div>
          <div class="row"><span class="k">Courthouse</span><span class="v">${esc(locationData.Name || 'N/A')}${locationData.FriendlyName ? ` (${esc(locationData.FriendlyName)})` : ''}</span></div>
          ${addr ? `<div class="row"><span class="k">Address</span><span class="v">${esc(addr)}</span></div>` : ""}

          <hr/>

          <h3 style="margin:0 0 10px; font-size:16px; font-weight:600;">Physical Court Filing</h3>
          <div class="row"><span class="k">Availability</span><span class="v">${pillHTML(canFile)}</span></div>

          ${canFile ? `
            ${(locationData.FileDeadline || locationData.FileServiceLevel) ? `
              <div class="deadline-box">
                <div class="label">Order by</div>
                <div class="time">${esc((locationData.FileDeadline || "").trim())}</div>
                <div class="hint">${locationData.FileServiceLevel ? `<strong>${esc((locationData.FileServiceLevel || "").trim())}</strong> service` : ""}</div>
              </div>
            ` : ""}

            ${(locationData.MaxFileCCDSOPSheriffDocSize || locationData.MaxFileCCDSOPSheriffEnvSize) ? `
              <button class="toggle" type="button" data-toggle="pfile-details" aria-expanded="false" data-show-text="Additional details ▼" data-hide-text="Additional details ▲">
                Additional details ▼
              </button>

              <div id="pfile-details" class="details hidden" style="margin-top:10px;">
                ${locationData.MaxFileCCDSOPSheriffDocSize ? `<div class="row"><span class="k">Max Doc Size</span><span class="v">${esc((locationData.MaxFileCCDSOPSheriffDocSize || "").trim())}</span></div>` : ""}
                ${locationData.MaxFileCCDSOPSheriffEnvSize ? `<div class="row"><span class="k">Max Envelope Size</span><span class="v">${esc((locationData.MaxFileCCDSOPSheriffEnvSize || "").trim())}</span></div>` : ""}
              </div>
            ` : ""}
          ` : ""}

          <hr/>

          <h3 style="margin:0 0 10px; font-size:16px; font-weight:600;">Courtesy Copy Delivery</h3>
          <div class="row"><span class="k">Availability</span><span class="v">${pillHTML(canCC)}</span></div>

          ${canCC ? `
            ${(locationData.CCDeliveryDeadline || locationData.CCDeliveryServiceLevel) ? `
              <div class="deadline-box">
                <div class="label">Order by</div>
                <div class="time">${esc((locationData.CCDeliveryDeadline || "").trim())}</div>
                <div class="hint">${locationData.CCDeliveryServiceLevel ? `<strong>${esc((locationData.CCDeliveryServiceLevel || "").trim())}</strong> service` : ""}</div>
              </div>
            ` : ""}

            ${(locationData.MaxFileCCDSOPSheriffDocSize || locationData.MaxFileCCDSOPSheriffEnvSize) ? `
              <button class="toggle" type="button" data-toggle="cc-details" aria-expanded="false" data-show-text="Additional details ▼" data-hide-text="Additional details ▲">
                Additional details ▼
              </button>

              <div id="cc-details" class="details hidden" style="margin-top:10px;">
                ${locationData.MaxFileCCDSOPSheriffDocSize ? `<div class="row"><span class="k">Max Doc Size</span><span class="v">${esc((locationData.MaxFileCCDSOPSheriffDocSize || "").trim())}</span></div>` : ""}
                ${locationData.MaxFileCCDSOPSheriffEnvSize ? `<div class="row"><span class="k">Max Envelope Size</span><span class="v">${esc((locationData.MaxFileCCDSOPSheriffEnvSize || "").trim())}</span></div>` : ""}
              </div>
            ` : ""}
          ` : ""}

          <hr/>

          <h3 style="margin:0 0 10px; font-size:16px; font-weight:600;">Sheriff Delivery</h3>
          <div class="row"><span class="k">Availability</span><span class="v">${pillHTML(canSheriff)}</span></div>

          ${canSheriff ? `
            ${(locationData.SheriffDeadline || locationData.SheriffServiceLevel) ? `
              <div class="deadline-box">
                <div class="label">Order by</div>
                <div class="time">${esc((locationData.SheriffDeadline || "").trim())}</div>
                <div class="hint">${locationData.SheriffServiceLevel ? `<strong>${esc((locationData.SheriffServiceLevel || "").trim())}</strong> service` : ""}</div>
              </div>
            ` : ""}

            ${(locationData.MaxFileCCDSOPSheriffDocSize || locationData.MaxFileCCDSOPSheriffEnvSize) ? `
              <button class="toggle" type="button" data-toggle="sheriff-details" aria-expanded="false" data-show-text="Additional details ▼" data-hide-text="Additional details ▲">
                Additional details ▼
              </button>

              <div id="sheriff-details" class="details hidden" style="margin-top:10px;">
                ${locationData.MaxFileCCDSOPSheriffDocSize ? `<div class="row"><span class="k">Max Doc Size</span><span class="v">${esc((locationData.MaxFileCCDSOPSheriffDocSize || "").trim())}</span></div>` : ""}
                ${locationData.MaxFileCCDSOPSheriffEnvSize ? `<div class="row"><span class="k">Max Envelope Size</span><span class="v">${esc((locationData.MaxFileCCDSOPSheriffEnvSize || "").trim())}</span></div>` : ""}
              </div>
            ` : ""}
          ` : ""}
        `;

        show($results);
        hide($physicalPrompt);
        wireToggles($results);

        renderSummary(courtWide, locationData);
        sendHeightSoon();
      } catch (error) {
        console.error('Error rendering location services:', error);
      }
    }

    // ----- Location combobox -----
    function populateListbox(locations) {
      try {
        if (!$listbox) {
          console.error('Listbox element not found');
          return;
        }

        $listbox.innerHTML = "";

        if (!locations || locations.length === 0) {
          const empty = document.createElement('li');
          empty.className = 'listbox-empty';
          empty.setAttribute('role', 'presentation');
          empty.textContent = 'No matching courthouse locations';
          $listbox.appendChild(empty);
          return;
        }

        const grouped = {};
        locations.forEach(loc => {
          const county = loc.County || "Other";
          if (!grouped[county]) grouped[county] = [];
          grouped[county].push(loc);
        });

        Object.keys(grouped).sort().forEach(county => {
          const groupHeader = document.createElement('li');
          groupHeader.className = 'listbox-group';
          groupHeader.setAttribute('role', 'presentation');
          groupHeader.textContent = county;
          $listbox.appendChild(groupHeader);

          grouped[county].sort((a, b) => (a.Name || "").localeCompare(b.Name || "")).forEach(loc => {
            const option = document.createElement('li');
            option.className = 'listbox-option';
            option.setAttribute('role', 'option');
            option.setAttribute('tabindex', '-1');
            option.setAttribute('data-court-id', loc.CourtId || '');
            option.textContent = (loc.Name || 'Unknown Location') + (loc.FriendlyName ? ` (${loc.FriendlyName})` : '');

            option.addEventListener('mousedown', (e) => {
              e.preventDefault();
              selectLocation(loc);
            });

            $listbox.appendChild(option);
          });
        });
      } catch (error) {
        console.error('Error populating location listbox:', error);
      }
    }

    // Best-practice autocomplete matching:
    // 1. Check if query appears as a substring anywhere
    // 2. Check if query matches the start of any word (word boundary)
    function matchesSearch(query, text) {
      if (!query || !text) return false;

      const q = query.toLowerCase();
      const t = text.toLowerCase();

      // Check if query appears as substring
      if (t.includes(q)) return true;

      // Check if query matches start of any word
      const words = t.split(/\s+/);
      return words.some(word => word.startsWith(q));
    }

    function filterOptions(query) {
      try {
        const q = (query || "").trim();

        if (!q) {
          populateListbox(allLocations);
          return;
        }

        // Filter locations using substring and word-boundary matching
        const results = allLocations.filter(loc => {
          // Search in Name, FriendlyName, Address, and City
          return matchesSearch(q, loc.Name || '') ||
                 matchesSearch(q, loc.FriendlyName || '') ||
                 matchesSearch(q, loc.Address_Address1 || '') ||
                 matchesSearch(q, loc.Address_City || '');
        });

        populateListbox(results);
      } catch (error) {
        console.error('Error filtering courthouse locations:', error);
        // Fallback to showing all locations on error
        populateListbox(allLocations);
      }
    }

    function openListbox() {
      if ($comboboxInput.disabled || allLocations.length === 0) return;
      isListboxOpen = true;
      $listbox.hidden = false;
      $comboboxWrapper.setAttribute('aria-expanded', 'true');
      sendHeightSoon();
    }

    function closeListbox() {
      isListboxOpen = false;
      $listbox.hidden = true;
      $comboboxWrapper.setAttribute('aria-expanded', 'false');
      sendHeightSoon();
    }

    function selectLocation(locationData) {
      try {
        if (!locationData) {
          console.error('No location data provided to selectLocation');
          return;
        }

        selectedLocation = locationData;
        $comboboxInput.value = locationData.Name || '';
        closeListbox();

        const courtWide = data.find(r => r.DisplayName === currentCourtName);

        if (!courtWide) {
          console.error('Court data not found for current selection');
          alert('Unable to load court information. Please try selecting a court again.');
          return;
        }

        renderLocationServices(locationData, courtWide);

      } catch (error) {
        console.error('Error in selectLocation:', error);
        alert('An error occurred while selecting the courthouse location. Please try again.');
      }
    }

    $comboboxInput.addEventListener('input', () => {
      const query = $comboboxInput.value;
      filterOptions(query);
      if (!isListboxOpen) openListbox();
    });

    $comboboxInput.addEventListener('click', () => {
      if (!$comboboxInput.disabled && allLocations.length > 0) {
        if (isListboxOpen) {
          closeListbox();
        } else {
          currentLocationInputValue = $comboboxInput.value;
          $comboboxInput.value = "";
          filterOptions("");
          openListbox();
        }
      }
    });

    $comboboxInput.addEventListener('focus', () => {
      if (!$comboboxInput.disabled && allLocations.length > 0 && !isListboxOpen) {
        currentLocationInputValue = $comboboxInput.value;
        $comboboxInput.value = "";
        filterOptions("");
        openListbox();
      }
    });

    $comboboxInput.addEventListener('blur', () => {
      setTimeout(() => {
        if (!isListboxOpen) return;
        if (selectedLocation && $comboboxInput.value !== selectedLocation.Name) {
          $comboboxInput.value = currentLocationInputValue;
        }
        closeListbox();
      }, 200);
    });

    // ----- Load CSV -----
    let data = [];
    try {
      const response = await fetch('court-db.csv', { cache: 'no-store' });

      if (!response.ok) {
        throw new Error(`Failed to load court data: HTTP ${response.status} - ${response.statusText}`);
      }

      const csv = await response.text();

      if (!csv || csv.trim().length === 0) {
        throw new Error('Court data file is empty');
      }

      const parseResult = Papa.parse(csv, { header: true, skipEmptyLines: true });

      if (parseResult.errors && parseResult.errors.length > 0) {
        console.error('CSV parsing warnings:', parseResult.errors);
      }

      if (!parseResult.data || parseResult.data.length === 0) {
        throw new Error('No valid court data found in CSV file');
      }

      data = parseResult.data;

    } catch (error) {
      console.error('Error loading court data:', error);

      // Display user-friendly error message
      const container = document.getElementById('form-container');
      if (container) {
        container.innerHTML = `
          <div style="padding: 20px; text-align: center;">
            <h2 style="color: #9b1c1c; margin-bottom: 12px;">Unable to Load Court Data</h2>
            <p style="color: #6b6b6b; margin-bottom: 8px;">
              ${error.message || 'An unexpected error occurred while loading court information.'}
            </p>
            <p style="color: #6b6b6b; font-size: 13px;">
              Please try refreshing the page. If the problem persists, contact support.
            </p>
            <button
              onclick="window.location.reload()"
              style="
                margin-top: 16px;
                padding: 10px 20px;
                background: #3a6edc;
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 14px;
                cursor: pointer;
                font-family: 'IBM Plex Sans', sans-serif;
              "
            >
              Retry
            </button>
          </div>
        `;
      }

      // Stop execution
      return;
    }

    // ----- Populate courts -----
    try {
      // Only include courts that have at least one location that is not permanently closed
      allCourts = uniq(data.filter(r => r.PermanentlyClosed !== "1").map(r => r.DisplayName).filter(Boolean));

      if (allCourts.length === 0) {
        throw new Error('No courts found in the data');
      }

      // Build fuzzy index for courts (strings wrapped as objects)
      courtFuse = new Fuse(allCourts.map(name => ({ name })), {
        keys: ["name"],
        threshold: 0.35,
        ignoreLocation: true,
        minMatchCharLength: 2
      });

    } catch (error) {
      console.error('Error initializing court search:', error);
      alert('Error initializing court data. Please refresh the page.');
      return;
    }

    function populateCourtListbox(courts = allCourts) {
      try {
        if (!$courtListbox) {
          console.error('Court listbox element not found');
          return;
        }

        $courtListbox.innerHTML = "";

        if (!courts || courts.length === 0) {
          const empty = document.createElement('li');
          empty.className = 'listbox-empty';
          empty.setAttribute('role', 'presentation');
          empty.textContent = 'No matching courts';
          $courtListbox.appendChild(empty);
          return;
        }

        courts.forEach(courtName => {
          const option = document.createElement('li');
          option.className = 'listbox-option';
          option.setAttribute('role', 'option');
          option.setAttribute('tabindex', '-1');
          option.textContent = courtName || 'Unknown Court';

          option.addEventListener('mousedown', (e) => {
            e.preventDefault();
            selectCourt(courtName);
          });

          $courtListbox.appendChild(option);
        });
      } catch (error) {
        console.error('Error populating court listbox:', error);
      }
    }

    function filterCourts(query) {
      try {
        const q = (query || "").trim();

        if (!q) {
          populateCourtListbox(allCourts);
          return;
        }

        // Filter courts using substring and word-boundary matching
        const results = allCourts.filter(courtName => {
          return matchesSearch(q, courtName);
        });

        populateCourtListbox(results);
      } catch (error) {
        console.error('Error filtering courts:', error);
        // Fallback to showing all courts on error
        populateCourtListbox(allCourts);
      }
    }

    function openCourtListbox() {
      isCourtListboxOpen = true;
      $courtListbox.hidden = false;
      $courtWrapper.setAttribute('aria-expanded', 'true');
      sendHeightSoon();
    }

    function closeCourtListbox() {
      isCourtListboxOpen = false;
      $courtListbox.hidden = true;
      $courtWrapper.setAttribute('aria-expanded', 'false');
      sendHeightSoon();
    }

    function selectCourt(courtName) {
      try {
        if (!courtName) {
          console.error('No court name provided to selectCourt');
          return;
        }

        currentCourtName = courtName;
        $courtInput.value = courtName;
        closeCourtListbox();

        // Reset courthouse
        $comboboxInput.value = "";
        $comboboxInput.disabled = false;
        $comboboxWrapper.classList.remove('disabled');
        selectedLocation = null;
        $listbox.innerHTML = "";
        closeListbox();

        hide($results);
        hide($physicalPrompt);
        hide($summary);
        hide($confirmation);

        const courtWide = data.find(r => r.DisplayName === courtName);

        if (!courtWide) {
          console.error(`Court "${courtName}" not found in data`);
          alert(`Unable to find information for "${courtName}". Please try another court.`);
          return;
        }

        renderEFiling(courtWide);
        renderSummary(courtWide, null);

        // Filter courthouse locations to exclude permanently closed ones
        allLocations = data.filter(r => r.DisplayName === courtName && r.PermanentlyClosed !== "1");

        // Build fuzzy index for locations (includes Name + address/city)
        try {
          locationFuse = new Fuse(allLocations, {
            keys: ["Name", "Address_Address1", "Address_City"],
            threshold: 0.35,
            ignoreLocation: true,
            minMatchCharLength: 2
          });
        } catch (fuseError) {
          console.error('Error initializing location search:', fuseError);
          // Continue without fuzzy search - fallback will work
          locationFuse = null;
        }

        renderPhysicalPrompt();
        sendHeightSoon();

      } catch (error) {
        console.error('Error in selectCourt:', error);
        alert('An error occurred while selecting the court. Please try again.');
      }
    }

    // Court combobox events
    $courtInput.addEventListener('input', () => {
      const query = $courtInput.value;
      filterCourts(query);
      if (!isCourtListboxOpen) openCourtListbox();
    });

    $courtInput.addEventListener('click', () => {
      if (isCourtListboxOpen) {
        closeCourtListbox();
      } else {
        currentCourtInputValue = $courtInput.value;
        $courtInput.value = "";
        filterCourts("");
        openCourtListbox();
      }
    });

    $courtInput.addEventListener('focus', () => {
      if (!isCourtListboxOpen) {
        currentCourtInputValue = $courtInput.value;
        $courtInput.value = "";
        filterCourts("");
        openCourtListbox();
      }
    });

    $courtInput.addEventListener('blur', () => {
      setTimeout(() => {
        if (!isCourtListboxOpen) return;
        if ($courtInput.value !== currentCourtName) {
          $courtInput.value = currentCourtInputValue;
        }
        closeCourtListbox();
      }, 200);
    });

    // Initial list
    populateCourtListbox(allCourts);

    // ----- Reset -----
    $reset.addEventListener('click', () => {
      $courtInput.value = "";
      closeCourtListbox();

      $comboboxInput.value = "";
      $comboboxInput.disabled = true;
      $comboboxWrapper.classList.add('disabled');
      selectedLocation = null;
      currentCourtName = "";
      allLocations = [];
      locationFuse = null;
      $listbox.innerHTML = "";
      closeListbox();

      hide($efiling);
      hide($results);
      hide($physicalPrompt);
      hide($summary);
      hide($confirmation);
      sendHeightSoon();
      scrollToEl(document.getElementById('form-container'));
    });

    // ----- URL PRESELECT (supports commas etc.) -----
    function getParam(name) {
      try {
        const params = new URLSearchParams(window.location.search);
        const v = params.get(name);
        return v ? v.trim() : "";
      } catch (error) {
        console.error('Error parsing URL parameters:', error);
        return "";
      }
    }

    try {
      const preselectCourt = getParam("court");
      if (preselectCourt) {
        const exact = allCourts.find(c => c.toLowerCase() === preselectCourt.toLowerCase());
        if (exact) {
          selectCourt(exact);
        } else if (courtFuse) {
          // try fuzzy match to closest court name
          try {
            const matches = courtFuse.search(preselectCourt, { limit: 1 });
            if (matches && matches.length > 0 && matches[0].item && matches[0].item.name) {
              selectCourt(matches[0].item.name);
            }
          } catch (searchError) {
            console.error('Error searching for court via URL parameter:', searchError);
          }
        }
      }
    } catch (error) {
      console.error('Error preselecting court from URL:', error);
      // Continue loading the page normally
    }

    // ----- SIGNAL READY TO PARENT -----
    // Tell parent page that iframe is ready to receive court selection
    // Send multiple times to avoid race conditions with parent listener setup
    function sendReadySignal() {
      try {
        window.parent.postMessage({ type: "onelegal_court_lookup_ready" }, "*");
      } catch (e) {
        // Ignore if not in iframe
      }
    }

    // Send immediately
    sendReadySignal();

    // Send again after small delays to ensure parent receives it
    setTimeout(sendReadySignal, 100);
    setTimeout(sendReadySignal, 300);
    setTimeout(sendReadySignal, 600);

    // ----- POSTMESSAGE LISTENER (for parent page preselection) -----
    window.addEventListener('message', (event) => {
      // Accept messages with court name from parent page
      if (event.data && event.data.court) {
        const courtName = String(event.data.court).trim();

        if (!courtName) return;

        // Try exact match first
        const exact = allCourts.find(c => c.toLowerCase() === courtName.toLowerCase());
        if (exact) {
          selectCourt(exact);
          return;
        }

        // Fallback to fuzzy match to handle slight variations
        if (courtFuse) {
          const match = courtFuse.search(courtName, { limit: 1 })[0];
          if (match && match.item && match.item.name) {
            selectCourt(match.item.name);
          }
        }
      }
    });

    // ----- IFRAME AUTO-HEIGHT -----
    let heightTimer = null;
    function sendHeightSoon() {
      if (heightTimer) clearTimeout(heightTimer);
      heightTimer = setTimeout(() => {
        try {
          const height = document.documentElement.scrollHeight;
          window.parent.postMessage({ type: "onelegal_court_lookup_height", height }, "*");
        } catch (e) {}
      }, 60);
    }
    window.addEventListener("load", sendHeightSoon);
    window.addEventListener("resize", sendHeightSoon);
    const observer = new MutationObserver(sendHeightSoon);
    observer.observe(document.body, { childList: true, subtree: true });
  })();
  </script>
</body>
</html>
